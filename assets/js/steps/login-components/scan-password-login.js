/**
 * @file
 * For users that scans username and types password to login.
 */

import React, { useState, useEffect, useContext } from "react";
import Header from "../components/Header";
import PropTypes from "prop-types";
import {
  faExclamationTriangle,
  faSignInAlt,
} from "@fortawesome/free-solid-svg-icons";
import BarcodeScanner from "../utils/barcode-scanner";
import QwertyKeyboard from "../utils/QwertyKeyboard";
import MachineStateContext from "../utils/MachineStateContext";
import {
  ScanPasswordLoginFirstSubheader,
  ScanPasswordLoginSecondSubheader,
  ScanPasswordLoginInputLabel,
  ScanPasswordLoginHeader,
  LoginLoginError,
} from "../utils/formatted-messages";
import BarcodeHandler from "../utils/barcode-handler";
import { ACTION_RESET, BARCODE_SCANNING_TIMEOUT } from "../../constants";
import BarcodeScannerIcon from "../../../scss/images/barcode-scanner.svg";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";

/**
 * ScanPasswordLogin.
 *
 * @param actionHandler
 *  As the state can only be changed by the statemachine, the actionHandler
 *  calls the statemachine if a user requests a state change.
 *
 * @return {*}
 * @constructor
 */
function ScanPasswordLogin({ actionHandler }) {
  const {
    boxConfig: { barcodeTimeout, debugEnabled, hasTouch },
    machineState: { loginError },
  } = useContext(MachineStateContext);
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [subheader, setSubheader] = useState(ScanPasswordLoginFirstSubheader);
  const [usernameScanned, setUsernameScanned] = useState(false);

  /**
   * Setup barcode scanner.
   */
  useEffect(() => {
    const barcodeScanner = new BarcodeScanner(
      barcodeTimeout ?? BARCODE_SCANNING_TIMEOUT
    );
    const barcodeCallback = new BarcodeHandler(
      [ACTION_RESET],
      actionHandler,
      () => {},
      function (outputCode) {
        handleUsernameInput(outputCode);
      }
    ).createCallback();

    barcodeScanner.start(barcodeCallback);
    return () => {
      barcodeScanner.stop();
    };
    // todo, below
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [actionHandler]);

  /**
   * For setting the username
   *
   * @param username
   *   The username.
   */
  function handleUsernameInput(username) {
    setUsername(username);
    setUsernameScanned(true);
    setSubheader(ScanPasswordLoginSecondSubheader);
  }

  /**
   * Handles numpad  presses.
   *
   * @param key
   *   The pressed button.
   */
  function onInput(key) {
    if (key === "{enter}") {
      login();
    } else {
      key === "{bksp}"
        ? setPassword(password.slice(0, -1))
        : setPassword(`${password}${key}`);
    }
  }

  /**
   * Function to handle when keydown is enter.
   */
  function enterFunction(event) {
    if (event.key === "Enter" && usernameScanned) {
      login();
    }
  }

  /**
   * Set up keydown listener.
   */
  useEffect(() => {
    window.addEventListener("keydown", enterFunction);
    return () => window.removeEventListener("keydown", enterFunction);
    // todo, below
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [password]);

  /**
   * Handles keyboard inputs.
   *
   * @param target
   *    The pressed target.
   */
  function onKeyboardInput({ target }) {
    setPassword(target.value);
  }

  /**
   * Handles login
   */
  function login() {
    actionHandler("login", {
      username,
      password,
    });
  }

  return (
    <>
      <Header
        header={ScanPasswordLoginHeader}
        subheader={subheader}
        type="login"
        icon={faSignInAlt}
      />
      <div className="col-md-3" />
      <div className="col-md-1" />
      <div className="col-md-6">
        {!usernameScanned && (
          <div className="content">
            <img src={BarcodeScannerIcon} height={300} width={300} />
          </div>
        )}
        {usernameScanned && (
          <>
            <div className={"input" + (loginError ? " error" : "")}>
              <label htmlFor={"password"}>{ScanPasswordLoginInputLabel}</label>
              <input
                name={"password"}
                id={"password"}
                type="password"
                value={password}
                onChange={onKeyboardInput}
                autoFocus
              />
              {loginError && (
                <div className="error-banner">
                  <span className="info-banner-icon">
                    <FontAwesomeIcon icon={faExclamationTriangle} />
                  </span>
                  {LoginLoginError}
                </div>
              )}
            </div>
          </>
        )}
      </div>
      <div className="col-md-5">
        {usernameScanned && (debugEnabled || hasTouch) && (
          <QwertyKeyboard handleKeyPress={onInput} />
        )}
      </div>
    </>
  );
}

ScanPasswordLogin.propTypes = {
  actionHandler: PropTypes.func.isRequired,
};

export default ScanPasswordLogin;
